<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="nofollow">
        <title>manage wiki</title>
    </head>
    <body>
        <h1>manage</h1>

        <p><span>
            <button id="new_button">new page</button> |
            <select id="sources_list"></select> 
            <button id="edit_button">edit</button>
            <button id="delete_button">delete</button>
            <button id="save_button">save</button>
            <button id="open_button">open</button>
        </span></p>

        <p>info: <span id="message"></span></p>

        <p><textarea id="edit_field" rows="20" style="width:100%"></textarea></p>

        <p>edit buffer loaded from: <span id="buffer_content"></span></p>

        <script>
            document.getElementById("new_button").addEventListener("click", create_source);
            document.getElementById("edit_button").addEventListener("click", edit_source);
            document.getElementById("delete_button").addEventListener("click", delete_source);
            document.getElementById("save_button").addEventListener("click", save_source);
            document.getElementById("open_button").addEventListener("click", open_html);

            window.onload = initialize();

            // initialize page when loaded
            function initialize() {
                console.log("initialize() called...");

                load_sources();

                document.getElementById("edit_field").value = "";
                document.getElementById("buffer_content").innerHTML = ""
            }

            // create new source page
            async function create_source() {
                console.log("create_source() called...");

                const source = prompt("source name", "*.md")

                if (source != null) {
                    const json_source_data = JSON.stringify({"data": ""});

                    try {
                        response = await fetch(`/api/sources/${source}`, {method: "PUT", headers: {"content-type": "application/json"}, body: json_source_data})

                        if (response.status == 200) {
                            show_message(`created new source file "${source}"`);
                        }
                        else {
                            show_message(`create failed failed (status code ${response.status}, "${response.statusText}")`);
                        }

                        load_sources(document.getElementById("buffer_content").innerHTML);
                    }
                    catch (error) {
                        show_message(`create failed with error "${error}"`);
                    }
                }
            }

            // delete source (and html) file currently active in select box
            async function delete_source() {
                console.log("delete_source() called...");

                const select = document.getElementById("sources_list");
                const source = select.options[select.selectedIndex].text;

                try {
                    response = await fetch(`/api/sources/${source}`, {method: "DELETE"});

                    if (response.status == 200) {
                        show_message(`deleted "${source}"`);
                    }
                    else {
                        show_message(`delete failed failed (status code ${response.status}, "${response.statusText}")`);
                    }

                    load_sources(document.getElementById("buffer_content").innerHTML);
                }
                catch (error) {
                    show_message(`delete failed with error "${error}"`);
                }
            }

            // edit source currently active in select box
            async function edit_source() {
                console.log("edit_source() called...");

                const select = document.getElementById("sources_list");
                const source = select.options[select.selectedIndex].text;

                try {
                    const response = await fetch(`/api/sources/${source}`);

                    if (response.status == 200) {
                        show_message(`editing "${source}"`);
                    }
                    else {
                        show_message(`edit failed failed (status code ${response.status}, "${response.statusText}")`);
                    }

                    const json_response = await response.json(); // should return a string

                    document.getElementById("edit_field").value = json_response;
                    document.getElementById("buffer_content").innerHTML = source;
                }
                catch (error) {
                    show_message(`edit failed with error "${error}"`);
                }
            }

            // open html page corresponding to currently active source in select box
            function open_html() {
                console.log("open_html() called...");

                const select = document.getElementById("sources_list");
                const source = select.options[select.selectedIndex].text;

                const html_page = source.substr(0, source.lastIndexOf(".")) + ".html";

                window.open(html_page)
            }

            // save edited source with name currently active in select box
            async function save_source() {
                console.log("save_source() called...");

                const select = document.getElementById("sources_list");
                const source = select.options[select.selectedIndex].text;

                const json_source_data = JSON.stringify({"data": document.getElementById("edit_field").value});

                try {
                    const response = await fetch(`/api/sources/${source}`, {method: "PUT", headers: {"content-type": "application/json"}, body: json_source_data});

                    if (response.status == 200) {
                        show_message(`saved as "${source}"`);
                    }
                    else {
                        show_message(`save_source failed failed (status code ${response.status}, "${response.statusText}")`);
                    }
                }
                catch (error) {
                    show_message(`save failed with error "${error}"`);
                }
            }

            // load list of sources and populate select box
            async function load_sources(select_option) {
                console.log("load_sources() called...");

                try {
                    const response = await fetch("/api/sources");

                    if (response.status != 200) {
                        show_message(`load failed failed (status code ${response.status}, "${response.statusText}")`);
                    }

                    const json_response = await response.json(); // should return a json array

                    json_response.sort();

                    let options = "";

                    for (let i = 0; i< json_response.length; i++) {
                        options += `<option>${json_response[i]}</option>`;
                    }

                    document.getElementById("sources_list").innerHTML = options;

                    if (select_option != undefined) {
                        options = document.getElementById("sources_list").options;
                    
                        for (let i = 0; i < options.length; i += 1) {
                            if (select_option == options[i].value) {
                                document.getElementById("sources_list").selectedIndex = i;
                                break;
                            }
                        }
                    }
                } catch (error) {
                    show_message(`load failed with error "${error}"`);
                }
            }

            function show_message(message) {
                document.getElementById("message").innerHTML = message;
                //setTimeout(() => {document.getElementById("message").innerHTML = "-"}, 4000);
            }
        </script>
    </body>
</html>
