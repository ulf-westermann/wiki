<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="nofollow">
        <title>manage wiki</title>
    </head>
    <body>
        <strong>manage markup files</strong><br>

        <span>
            <button id="new_markup_button">new</button> |
            <select id="markup_select"></select> 
            <button id="edit_markup_button">edit</button>
            <button id="delete_markup_button">delete</button>
            <button id="save_markup_button">save</button>
            <button id="open_html_button">open</button>
	    </span><br>

        <small><span id="markup_message"></span></small><br>

	<textarea id="edit_field" rows="20" style="width:99%"></textarea><br>

        <small>buffer loaded from: <span id="buffer_content"></span></small>

        <hr />

        <strong>manage media files</strong><br>
            
        <span>
            <input id="media_input" type="file" multiple />
            <button id="upload_media_button">upload</button>
        </span><br>

        <span>
            <select id="media_select"></select> 
            <button id="delete_media_button">delete</button>
        </span><br>

        <small><span id="media_message"></span></small>


        <script>
            document.getElementById("new_markup_button").addEventListener("click", new_markup);
            document.getElementById("edit_markup_button").addEventListener("click", edit_markup);
            document.getElementById("delete_markup_button").addEventListener("click", delete_markup);
            document.getElementById("save_markup_button").addEventListener("click", save_markup);
            document.getElementById("open_html_button").addEventListener("click", open_html);
            document.getElementById("upload_media_button").addEventListener("click", upload_media);
            document.getElementById("delete_media_button").addEventListener("click", delete_media);

            window.onload = initialize();

            // initialize page when loaded
            function initialize() {
                console.log("initialize() called...");

                load_markup();
                load_media();

                document.getElementById("edit_field").value = "";
                document.getElementById("buffer_content").innerHTML = ""
            }

            // load list of markup files and populate select box
            async function load_markup(select_option) {
                console.log("load_markup() called...");

                try {
                    const response = await fetch("/api/markup");

                    if (response.status != 200) {
                        show_markup_message(`load markup files failed (status code ${response.status}, "${response.statusText}")`);
                    }

                    const json_response = await response.json(); // should return a json array

                    json_response.sort();

                    let options = "";

                    for (let i = 0; i< json_response.length; i++) {
                        options += `<option>${json_response[i]}</option>`;
                    }

                    document.getElementById("markup_select").innerHTML = options;

                    if (select_option != undefined) {
                        options = document.getElementById("markup_select").options;
                    
                        for (let i = 0; i < options.length; i += 1) {
                            if (select_option == options[i].value) {
                                document.getElementById("markup_select").selectedIndex = i;
                                break;
                            }
                        }
                    }
                } catch (error) {
                    show_markup_message(`load markup files failed with error "${error}"`);
                }
            }

            // create new markup page
            async function new_markup() {
                console.log("new_markup() called...");

                const source = prompt("markup file name", "*.md")

                if (source != null) {
                    const json_source_data = JSON.stringify({"data": ""});

                    try {
                        response = await fetch(`/api/markup/${source}`, {method: "PUT", headers: {"content-type": "application/json"}, body: json_source_data})

                        if (response.status == 200) {
                            show_markup_message(`created new markup file "${source}"`);
                            load_markup(document.getElementById("buffer_content").innerHTML);
                        }
                        else {
                            show_markup_message(`create markup file failed (status code ${response.status}, "${response.statusText}")`);
                        }
                    }
                    catch (error) {
                        show_markup_message(`create markup file failed with error "${error}"`);
                    }
                }
            }

            // edit markup file currently active in select box
            async function edit_markup() {
                console.log("edit_markup() called...");

                const select = document.getElementById("markup_select");
                const source = select.options[select.selectedIndex].text;

                try {
                    const response = await fetch(`/api/markup/${source}`);

                    if (response.status == 200) {
                        show_markup_message(`editing markup file "${source}"`);
                    }
                    else {
                        show_markup_message(`edit markup file failed (status code ${response.status}, "${response.statusText}")`);
                    }

                    const json_response = await response.json(); // should return a string

                    document.getElementById("edit_field").value = json_response;
                    document.getElementById("buffer_content").innerHTML = source;
                }
                catch (error) {
                    show_markup_message(`edit markup file failed with error "${error}"`);
                }
            }

            // delete markup (and html) file currently active in select box
            async function delete_markup() {
                console.log("delete_markup() called...");

                const select = document.getElementById("markup_select");
                const source = select.options[select.selectedIndex].text;

                try {
                    response = await fetch(`/api/markup/${source}`, {method: "DELETE"});

                    if (response.status == 200) {
                        show_markup_message(`deleted markup file "${source}"`);
                    }
                    else {
                        show_markup_message(`delete markup file failed (status code ${response.status}, "${response.statusText}")`);
                    }

                    load_markup(document.getElementById("buffer_content").innerHTML);
                }
                catch (error) {
                    show_markup_message(`delete markup file failed with error "${error}"`);
                }
            }

            // save edited markup file with name currently active in select box
            async function save_markup() {
                console.log("save_markup() called...");

                const select = document.getElementById("markup_select");
                const source = select.options[select.selectedIndex].text;

                const json_source_data = JSON.stringify({"data": document.getElementById("edit_field").value});

                try {
                    const response = await fetch(`/api/markup/${source}`, {method: "PUT", headers: {"content-type": "application/json"}, body: json_source_data});

                    if (response.status == 200) {
                        show_markup_message(`saved markup file as "${source}"`);
                    }
                    else {
                        show_markup_message(`save markup file failed (status code ${response.status}, "${response.statusText}")`);
                    }
                }
                catch (error) {
                    show_markup_message(`save markup file failed with error "${error}"`);
                }
            }

            // open html page corresponding to currently active markup file in select box
            function open_html() {
                console.log("open_html() called...");

                const select = document.getElementById("markup_select");
                const source = select.options[select.selectedIndex].text;

                const html_page = source.substr(0, source.lastIndexOf(".")) + ".html";

                window.open(html_page)
            }

            // load list of media files and populate select box
            async function load_media() {
                console.log("load_media() called...");

                try {
                    const response = await fetch("/api/media");

                    if (response.status != 200) {
                        show_media_message(`load media files failed (status code ${response.status}, "${response.statusText}")`);
                    }

                    const json_response = await response.json(); // should return a json array

                    json_response.sort();

                    let options = "";

                    for (let i = 0; i< json_response.length; i++) {
                        options += `<option>${json_response[i]}</option>`;
                    }

                    document.getElementById("media_select").innerHTML = options;
                } catch (error) {
                    show_media_message(`load media files failed with error "${error}"`);
                }
            }

            // upload multiple media files
            async function upload_media() {
                console.log("upload_media() called...");

                const files_data = new FormData();

                try {
                    const file_list = document.getElementById("media_input").files;
                    let message_string = "uploaded media file(s):";

                    for (const file of file_list) {
                        files_data.append("files", file);
                        message_string += " " + file.name
                    }

                    const response = await fetch("/api/media", {method: "PUT", body: files_data});

                    if (response.status == 200) {
                        show_media_message(message_string);
                        load_media();
                    }
                    else {
                        show_media_message(`upload media files failed (status code ${response.status}, "${response.statusText}")`);
                    }
                }
                catch (error) {
                    show_media_message(`upload media files failed with error "${error}"`);
                }
            }

            // delete media file currently active in select box
            async function delete_media() {
                console.log("delete_media() called...");

                const select = document.getElementById("media_select");
                const source = select.options[select.selectedIndex].text;

                try {
                    response = await fetch(`/api/media/${source}`, {method: "DELETE"});

                    if (response.status == 200) {
                        show_media_message(`deleted media file "${source}"`);
                    }
                    else {
                        show_media_message(`delete media file failed (status code ${response.status}, "${response.statusText}")`);
                    }

                    load_media();
                }
                catch (error) {
                    show_media_message(`delete media file failed with error "${error}"`);
                }
            }

            // helper function to show markup info message
            function show_markup_message(message) {
                document.getElementById("markup_message").innerHTML = message;
                //setTimeout(() => {document.getElementById("markup_message").innerHTML = "-"}, 4000);
            }

            // helper function to show media info message
            function show_media_message(message) {
                document.getElementById("media_message").innerHTML = message;
                //setTimeout(() => {document.getElementById("media_message").innerHTML = "-"}, 4000);
            }
        </script>
    </body>
</html>
