<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="nofollow">
        <title>manage wiki</title>
    </head>
    <body>
        <h1>manage</h1>

        <p><span>
            <button onclick="create_source()">new page</button> |
            <select id="sources_list"></select> 
            <button id="edit_button">edit</button>
            <button id="delete_button">delete</button>
            <button id="open_button">open</button>
        </span></p>

        <p><textarea id="edit_field" rows="20" style="width:100%"></textarea></p>
        <p>edit buffer loaded from: <span id="buffer_content">-</span></p>
        <p><button id="save_button" onclick="save_source()">save</button><span id="saved_info"></span></p>

        <script>
            document.getElementById("edit_button").addEventListener("click", edit_source);
            document.getElementById("delete_button").addEventListener("click", delete_source);
            document.getElementById("open_button").addEventListener("click", open_html);

            window.onload = initialize();

            // initialize page when loaded
            function initialize() {
                console.log("initialize() called...");

		// todo: reselect last sources in select box, if still valid, or delete content of textarea
                load_sources();

                document.getElementById("edit_field").value = "";
                document.getElementById("buffer_content").innerHTML = "-"

            }

            // create new source page
            async function create_source() {
                console.log("create_source() called...");

                const source = prompt("source name", "*.md")

                if (source != null) {
                    const json_source_data = JSON.stringify({"data": ""});

                    try {
                        await fetch(`/api/sources/${source}`, {method: "PUT", headers: {"content-type": "application/json"}, body: json_source_data})
                        load_sources();
                    }
                    catch (error) {
                        console.log("fetch failed", error);
                    }
                }
            }

            // delete source (and html) file currently active in select box
            async function delete_source() {
                console.log("delete_source() called...");

                const select = document.getElementById("sources_list");
                const source = select.options[select.selectedIndex].text;

                try {
                    await fetch(`/api/sources/${source}`, {method: "DELETE"});
                    load_sources();
                }
                catch (error) {
                    console.log("fetch failed", error);
                }
            }

            // edit source currently active in select box
            async function edit_source() {
                console.log("edit_source() called...");

                const select = document.getElementById("sources_list");
                const source = select.options[select.selectedIndex].text;

                try {
                    const response = await fetch(`/api/sources/${source}`);
                    const json_response = await response.json(); // should return a string

                    document.getElementById("edit_field").value = json_response;
                    document.getElementById("buffer_content").innerHTML = source;
                }
                catch (error) {
                    console.log("fetch failed");
                }
            }

            // open html page corresponding to currently active source in select box
            function open_html() {
                console.log("open_html() called...");

                const select = document.getElementById("sources_list");
                const source = select.options[select.selectedIndex].text;

                const html_page = source.substr(0, source.lastIndexOf(".")) + ".html";

                window.open(html_page)
            }

            // save edited source with name currently active in select box
            async function save_source() {
                console.log("save_source() called...");

                const select = document.getElementById("sources_list");
                const source = select.options[select.selectedIndex].text;

                const json_source_data = JSON.stringify({"data": document.getElementById("edit_field").value});

                console.log(`json_source_data: ${json_source_data}`);

                try {
                    const response = await fetch(`/api/sources/${source}`, {method: "PUT", headers: {"content-type": "application/json"}, body: json_source_data});
                    if (response.status != 200) {
                        console.log(`fetch failed with status code ${response.status}: ${response.statusText}`);
                    }
                }
                catch (error) {
                    console.log("fetch failed", error);
                }
            }

            // load list of sources and populate select box
            async function load_sources() {
                console.log("load_sources() called...");

                try {
                    const response = await fetch("/api/sources");
                    const json_response = await response.json(); // should return a json array

                    json_response.sort();

                    let selected_index = document.getElementById("sources_list").selectedIndex;
                    selected_index = selected_index = -1 ? 0 : selected_index;

                    let options = "";

                    for (let i = 0; i< json_response.length; i++) {
                        options += `<option>${json_response[i]}</option>`;
                    }

                    document.getElementById("sources_list").innerHTML = options;
                    document.getElementById("sources_list").selectedIndex = selected_index;
                } catch (error) {
                    console.log("fetch failed", error);
                }
            }
        </script>
    </body>
</html>
